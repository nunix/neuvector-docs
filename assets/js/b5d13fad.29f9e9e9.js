"use strict";(self.webpackChunkdocs=self.webpackChunkdocs||[]).push([[2626],{62181:(e,n,o)=>{o.r(n),o.d(n,{assets:()=>a,contentTitle:()=>s,default:()=>d,frontMatter:()=>c,metadata:()=>i,toc:()=>l});var r=o(85893),t=o(11151);const c={title:"OpenShift (Allinone)",taxonomy:{category:"docs"},slug:"/special/openshift"},s=void 0,i={id:"special/openshift/openshift",title:"OpenShift (Allinone)",description:"Deploy Using RedHat OpenShift",source:"@site/versioned_docs/version-5.2/13.special/03.openshift/03.openshift.md",sourceDirName:"13.special/03.openshift",slug:"/special/openshift",permalink:"/neuvector-docs/5.2/special/openshift",draft:!1,unlisted:!1,editUrl:"https://github.com/neuvector/docs/edit/main/versioned_docs/version-5.2/13.special/03.openshift/03.openshift.md",tags:[],version:"5.2",sidebarPosition:3,frontMatter:{title:"OpenShift (Allinone)",taxonomy:{category:"docs"},slug:"/special/openshift"},sidebar:"tutorialSidebar",previous:{title:"Kubernetes (Allinone)",permalink:"/neuvector-docs/5.2/special/kubernetes"},next:{title:"Mirantis Kubernetes Engine",permalink:"/neuvector-docs/5.2/special/docker"}},a={},l=[{value:"Deploy Using RedHat OpenShift",id:"deploy-using-redhat-openshift",level:3},{value:"Enable/Disable Scheduling on the Master Node",id:"enabledisable-scheduling-on-the-master-node",level:3}];function u(e){const n={admonition:"admonition",code:"code",h3:"h3",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",...(0,t.a)(),...e.components};return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(n.h3,{id:"deploy-using-redhat-openshift",children:"Deploy Using RedHat OpenShift"}),"\n",(0,r.jsx)(n.p,{children:"NeuVector is compatible with standard ovs SDN plug-ins as well as others such as flannel, weave, or calico. The samples below assume a standard ovs plug-in is used. This also assumes a local docker registry will be used. The default yaml deployment deploys one allinone on a labeled node and enforcers on all others, including the master."}),"\n",(0,r.jsx)(n.p,{children:"First, pull the appropriate NeuVector containers from the NeuVector registry into your local registry."}),"\n",(0,r.jsx)(n.p,{children:"For Docker Hub"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-shell",children:"docker pull docker.io/neuvector/allinone:5.2.0\ndocker pull docker.io/neuvector/enforcer:5.2.0\ndocker pull docker.io/neuvector/scanner\ndocker pull docker.io/neuvector/updater\n"})}),"\n",(0,r.jsx)(n.p,{children:"Next, tag/push the containers, set the route and allow privileged NeuVector containers using the instructions below. By default, OpenShift does not allow privileged containers. Also, by default OpenShift does not schedule pods on the Master node. See the instructions at the end to enable/disable this."}),"\n",(0,r.jsx)(n.admonition,{type:"note",children:(0,r.jsx)(n.p,{children:"Please see the Enterprise Integration section for details on integration with OpenShift Role Based Access Controls (RBACs)."})}),"\n",(0,r.jsxs)(n.ol,{children:["\n",(0,r.jsx)(n.li,{children:"Login as a normal user"}),"\n"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-shell",children:"oc login -u <user_name>\n"})}),"\n",(0,r.jsxs)(n.ol,{start:"2",children:["\n",(0,r.jsx)(n.li,{children:"Create a new project"}),"\n"]}),"\n",(0,r.jsx)(n.admonition,{type:"note",children:(0,r.jsx)(n.p,{children:"If the --node-selector argument is used when creating a project this will restrict pod placement such as for the NeuVector enforcer to specific nodes."})}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-shell",children:"oc new-project neuvector\n"})}),"\n",(0,r.jsxs)(n.ol,{start:"3",children:["\n",(0,r.jsx)(n.li,{children:"Push NeuVector images to OpenShift docker registry. IMPORTANT! The docker login below is for the docker-registry (not to be confused with the oc login above), and requires the user/authentication token in the command."}),"\n"]}),"\n",(0,r.jsx)(n.admonition,{type:"note",children:(0,r.jsx)(n.p,{children:"For OpenShift 4.6+, change docker-registry.default.svc below to image-registry.openshift-image-registry.svc in the commands below."})}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-shell",children:"docker login -u <user_name> -p `oc whoami -t` docker-registry.default.svc:5000\ndocker tag docker.io/neuvector/allinone:<version> docker-registry.default.svc:5000/neuvector/allinone\ndocker tag docker.io/neuvector/enforcer:<version> docker-registry.default.svc:5000/neuvector/enforcer\ndocker tag docker.io/neuvector/scanner docker-registry.default.svc:5000/neuvector/scanner\ndocker tag docker.io/neuvector/updater docker-registry.default.svc:5000/neuvector/updater\ndocker push docker-registry.default.svc:5000/neuvector/allinone\ndocker push docker-registry.default.svc:5000/neuvector/enforcer\ndocker push docker-registry.default.svc:5000/neuvector/scanner\ndocker push docker-registry.default.svc:5000/neuvector/updater\ndocker logout docker-registry.default.svc:5000\n"})}),"\n",(0,r.jsxs)(n.ol,{start:"4",children:["\n",(0,r.jsxs)(n.li,{children:["Login as system",":admin"," account"]}),"\n"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-shell",children:"oc login -u system:admin\n"})}),"\n",(0,r.jsxs)(n.ol,{start:"5",children:["\n",(0,r.jsx)(n.li,{children:"Create Service Accounts and Grant Service Account Access to the Privileged SCC"}),"\n"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-shell",children:"oc create sa controller -n neuvector\noc create sa enforcer -n neuvector\noc create sa basic -n neuvector\noc create sa updater -n neuvector\noc -n neuvector adm policy add-scc-to-user privileged -z controller -z enforcer\n"})}),"\n",(0,r.jsx)(n.p,{children:"The following info will be added in the Privileged SCC\nusers:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-shell",children:"- system:serviceaccount:neuvector:controller\n- system:serviceaccount:neuvector:enforcer\n"})}),"\n",(0,r.jsx)(n.p,{children:"In OpenShift 4.6+ use the following to check:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-shell",children:"oc get rolebinding system:openshift:scc:privileged -n neuvector -o wide\n"})}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-shell",children:"NAME                              ROLE                                          AGE     USERS   GROUPS   SERVICEACCOUNTS\nsystem:openshift:scc:privileged   ClusterRole/system:openshift:scc:privileged   9m22s                    neuvector/controller, neuvector/enforcer\n"})}),"\n",(0,r.jsx)(n.p,{children:"Create the custom resources (CRD) for NeuVector security rules. For OpenShift 4.6+ (Kubernetes 1.19+):"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-shell",children:"oc apply -f https://raw.githubusercontent.com/neuvector/manifests/main/kubernetes/5.2.0/crd-k8s-1.19.yaml\noc apply -f https://raw.githubusercontent.com/neuvector/manifests/main/kubernetes/5.2.0/waf-crd-k8s-1.19.yaml\noc apply -f https://raw.githubusercontent.com/neuvector/manifests/main/kubernetes/5.2.0/dlp-crd-k8s-1.19.yaml\noc apply -f https://raw.githubusercontent.com/neuvector/manifests/main/kubernetes/5.2.0/admission-crd-k8s-1.19.yaml\n"})}),"\n",(0,r.jsxs)(n.ol,{start:"6",children:["\n",(0,r.jsx)(n.li,{children:"Add read permission to access the kubernetes API and OpenShift RBACs. IMPORTANT: The standard NeuVector 5.2+ deployment uses least-privileged service accounts instead of the default. See below if upgrading to 5.2+ from a version prior to 5.2."}),"\n"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-shell",children:"oc create clusterrole neuvector-binding-app --verb=get,list,watch,update --resource=nodes,pods,services,namespaces\noc create clusterrole neuvector-binding-rbac --verb=get,list,watch --resource=rolebindings.rbac.authorization.k8s.io,roles.rbac.authorization.k8s.io,clusterrolebindings.rbac.authorization.k8s.io,clusterroles.rbac.authorization.k8s.io,imagestreams.image.openshift.io\noc adm policy add-cluster-role-to-user neuvector-binding-app system:serviceaccount:neuvector:controller\noc adm policy add-cluster-role-to-user neuvector-binding-rbac system:serviceaccount:neuvector:controller\noc create clusterrole neuvector-binding-admission --verb=get,list,watch,create,update,delete --resource=validatingwebhookconfigurations,mutatingwebhookconfigurations\noc adm policy add-cluster-role-to-user neuvector-binding-admission system:serviceaccount:neuvector:controller\noc create clusterrole neuvector-binding-customresourcedefinition --verb=watch,create,get,update --resource=customresourcedefinitions\noc adm policy add-cluster-role-to-user neuvector-binding-customresourcedefinition system:serviceaccount:neuvector:controller\noc create clusterrole neuvector-binding-nvsecurityrules --verb=list,delete --resource=nvsecurityrules,nvclustersecurityrules\noc adm policy add-cluster-role-to-user neuvector-binding-nvsecurityrules system:serviceaccount:neuvector:controller\noc adm policy add-cluster-role-to-user view system:serviceaccount:neuvector:controller --rolebinding-name=neuvector-binding-view\noc create clusterrole neuvector-binding-nvwafsecurityrules --verb=list,delete --resource=nvwafsecurityrules\noc adm policy add-cluster-role-to-user neuvector-binding-nvwafsecurityrules system:serviceaccount:neuvector:controller\noc create clusterrole neuvector-binding-nvadmissioncontrolsecurityrules --verb=list,delete --resource=nvadmissioncontrolsecurityrules\noc adm policy add-cluster-role-to-user neuvector-binding-nvadmissioncontrolsecurityrules system:serviceaccount:neuvector:controller\noc create clusterrole neuvector-binding-nvdlpsecurityrules --verb=list,delete --resource=nvdlpsecurityrules\noc adm policy add-cluster-role-to-user neuvector-binding-nvdlpsecurityrules system:serviceaccount:neuvector:controller\noc create role neuvector-binding-scanner --verb=get,patch,update,watch --resource=deployments -n neuvector\noc adm policy add-role-to-user neuvector-binding-scanner system:serviceaccount:neuvector:updater system:serviceaccount:neuvector:controller -n neuvector --role-namespace neuvector\noc create clusterrole neuvector-binding-csp-usages --verb=get,create,update,delete --resource=cspadapterusagerecords\noc adm policy add-cluster-role-to-user neuvector-binding-csp-usages system:serviceaccount:neuvector:controller\noc create clusterrole neuvector-binding-co --verb=get,list --resource=clusteroperators\noc adm policy add-cluster-role-to-user neuvector-binding-co system:serviceaccount:neuvector:enforcer system:serviceaccount:neuvector:controller\n"})}),"\n",(0,r.jsx)(n.admonition,{type:"note",children:(0,r.jsx)(n.p,{children:"If upgrading from a previous NeuVector deployment (prior to 5.2), you will need to delete the old bindings, then create new ones:"})}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-shell",children:"oc delete clusterrolebinding neuvector-binding-app neuvector-binding-rbac neuvector-binding-admission neuvector-binding-customresourcedefinition neuvector-binding-nvsecurityrules neuvector-binding-view neuvector-binding-nvwafsecurityrules neuvector-binding-nvadmissioncontrolsecurityrules neuvector-binding-nvdlpsecurityrules neuvector-binding-co\noc delete rolebinding neuvector-admin -n neuvector\noc adm policy add-cluster-role-to-user neuvector-binding-app system:serviceaccount:neuvector:controller\noc adm policy add-cluster-role-to-user neuvector-binding-rbac system:serviceaccount:neuvector:controller\noc adm policy add-cluster-role-to-user neuvector-binding-admission system:serviceaccount:neuvector:controller\noc adm policy add-cluster-role-to-user neuvector-binding-customresourcedefinition system:serviceaccount:neuvector:controller\noc adm policy add-cluster-role-to-user neuvector-binding-nvsecurityrules system:serviceaccount:neuvector:controller\noc adm policy add-cluster-role-to-user view system:serviceaccount:neuvector:controller --rolebinding-name=neuvector-binding-view\noc adm policy add-cluster-role-to-user neuvector-binding-nvwafsecurityrules system:serviceaccount:neuvector:controller\noc adm policy add-cluster-role-to-user neuvector-binding-nvadmissioncontrolsecurityrules system:serviceaccount:neuvector:controller\noc adm policy add-cluster-role-to-user neuvector-binding-nvdlpsecurityrules system:serviceaccount:neuvector:controller\noc create role neuvector-binding-scanner --verb=get,patch,update,watch --resource=deployments -n neuvector\noc adm policy add-role-to-user neuvector-binding-scanner system:serviceaccount:neuvector:updater system:serviceaccount:neuvector:controller -n neuvector --role-namespace neuvector\noc create clusterrole neuvector-binding-csp-usages --verb=get,create,update,delete --resource=cspadapterusagerecords\noc adm policy add-cluster-role-to-user neuvector-binding-csp-usages system:serviceaccount:neuvector:controller\noc adm policy add-cluster-role-to-user neuvector-binding-co system:serviceaccount:neuvector:enforcer system:serviceaccount:neuvector:controller\n"})}),"\n",(0,r.jsxs)(n.ol,{start:"7",children:["\n",(0,r.jsx)(n.li,{children:"Run the following command to check if the neuvector/controller, neuvector/enforcer and neuvector/updater service accounts are added successfully."}),"\n"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-shell",children:"oc get ClusterRoleBinding neuvector-binding-app neuvector-binding-rbac neuvector-binding-admission neuvector-binding-customresourcedefinition neuvector-binding-nvsecurityrules neuvector-binding-view neuvector-binding-nvwafsecurityrules neuvector-binding-nvadmissioncontrolsecurityrules neuvector-binding-nvdlpsecurityrules neuvector-binding-csp-usages neuvector-binding-co -o wide\n"})}),"\n",(0,r.jsx)(n.p,{children:"Sample output:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-shell",children:"NAME                                                ROLE                                                            AGE   USERS   GROUPS   SERVICEACCOUNTS\nneuvector-binding-app                               ClusterRole/neuvector-binding-app                               56d                    neuvector/controller\nneuvector-binding-rbac                              ClusterRole/neuvector-binding-rbac                              34d                    neuvector/controller\nneuvector-binding-admission                         ClusterRole/neuvector-binding-admission                         72d                    neuvector/controller\nneuvector-binding-customresourcedefinition          ClusterRole/neuvector-binding-customresourcedefinition          72d                    neuvector/controller\nneuvector-binding-nvsecurityrules                   ClusterRole/neuvector-binding-nvsecurityrules                   72d                    neuvector/controller\nneuvector-binding-view                              ClusterRole/view                                                72d                    neuvector/controller\nneuvector-binding-nvwafsecurityrules                ClusterRole/neuvector-binding-nvwafsecurityrules                72d                    neuvector/controller\nneuvector-binding-nvadmissioncontrolsecurityrules   ClusterRole/neuvector-binding-nvadmissioncontrolsecurityrules   72d                    neuvector/controller\nneuvector-binding-nvdlpsecurityrules                ClusterRole/neuvector-binding-nvdlpsecurityrules                72d                    neuvector/controller\nneuvector-binding-csp-usages                        ClusterRole/neuvector-binding-csp-usages                        24d                    neuvector/controller\nneuvector-binding-co                                ClusterRole/neuvector-binding-co                                72d                    neuvector/enforcer, neuvector/controller\n"})}),"\n",(0,r.jsx)(n.p,{children:"And this command:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-shell",children:"oc get RoleBinding neuvector-binding-scanner -n neuvector -o wide\n"})}),"\n",(0,r.jsx)(n.p,{children:"Sample output:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-shell",children:"NAME                        ROLE                             AGE   USERS   GROUPS   SERVICEACCOUNTS\nneuvector-binding-scanner   Role/neuvector-binding-scanner   70d                    neuvector/updater, neuvector/controller\n"})}),"\n",(0,r.jsxs)(n.ol,{start:"8",children:["\n",(0,r.jsx)(n.li,{children:"Add a nvallinone label on one of the master or worker nodes where the allinone will be deployed"}),"\n"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-shell",children:"oc label nodes <nodename> nvallinone=true\n"})}),"\n",(0,r.jsxs)(n.ol,{start:"9",children:["\n",(0,r.jsx)(n.li,{children:"Create the neuvector services and pods based on the sample yaml files below"}),"\n"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-shell",children:"oc create -f <compose file>\n"})}),"\n",(0,r.jsx)(n.p,{children:"If you have created your own namespace instead of using \u201cneuvector\u201d:"}),"\n",(0,r.jsxs)(n.ol,{children:["\n",(0,r.jsx)(n.li,{children:"Replace all instances of \u201cnamespace: neuvector\u201d with your namespace."}),"\n",(0,r.jsx)(n.li,{children:"Search for all instances of \u201dneuvector-svc-allinone.neuvector\u201d in the files below. Then replace the \u201cneuvector\u201d (after the .) with the namespace you use."}),"\n"]}),"\n",(0,r.jsx)(n.admonition,{type:"note",children:(0,r.jsx)(n.p,{children:"If you are using the Allinone container for testing NeuVector, deploy only one Allinone for your cluster. Multiple Manager instances are not supported on Kubernetes. To test high availability for the Controller refer to the Deploying in Production section."})}),"\n",(0,r.jsx)("strong",{children:"Sample Config File for OpenShift 4.6+"}),"\n",(0,r.jsx)(n.admonition,{type:"note",children:(0,r.jsx)(n.p,{children:"For 4.6+, see the section Deploying NeuVector / OpenShift for yaml file changes required for the CRI-O run-time and for changing the default registry."})}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-yaml",children:'apiVersion: v1\nkind: Service\nmetadata:\n  name: neuvector-svc-crd-webhook\n  namespace: neuvector\nspec:\n  ports:\n  - port: 443\n    targetPort: 30443\n    protocol: TCP\n    name: crd-webhook\n  type: ClusterIP\n  selector:\n    app: neuvector-allinone-pod\n\n---\n\napiVersion: v1\nkind: Service\nmetadata:\n  name: neuvector-svc-admission-webhook\n  namespace: neuvector\nspec:\n  ports:\n  - port: 443\n    targetPort: 20443\n    protocol: TCP\n    name: admission-webhook\n  type: ClusterIP\n  selector:\n    app: neuvector-allinone-pod\n\n---\n\napiVersion: v1\nkind: Service\nmetadata:\n  name: neuvector-service-webui\n  namespace: neuvector\nspec:\n  ports:\n    - port: 8443\n      name: manager\n      protocol: TCP\n  type: ClusterIP\n  selector:\n    app: neuvector-allinone-pod\n\n---\n\napiVersion: v1\nkind: Service\nmetadata:\n  name: neuvector-svc-allinone\n  namespace: neuvector\nspec:\n  ports:\n  - port: 18300\n    protocol: "TCP"\n    name: "cluster-tcp-18300"\n  - port: 18301\n    protocol: "TCP"\n    name: "cluster-tcp-18301"\n  - port: 18301\n    protocol: "UDP"\n    name: "cluster-udp-18301"\n  clusterIP: None\n  selector:\n    app: neuvector-allinone-pod\n\n---\n\napiVersion: route.openshift.io/v1\nkind: Route\nmetadata:\n  name: neuvector-route-webui\n  namespace: neuvector\nspec:\n  to:\n    kind: Service\n    name: neuvector-service-webui\n  port:\n    targetPort: manager\n  tls:\n    termination: passthrough\n\n---\n\napiVersion: apps/v1\nkind: DaemonSet\nmetadata:\n  name: neuvector-allinone-pod\n  namespace: neuvector\nspec:\n  selector:\n    matchLabels:\n      app: neuvector-allinone-pod\n  minReadySeconds: 60\n  updateStrategy:\n    type: RollingUpdate\n    rollingUpdate:\n      maxUnavailable: 1\n  template:\n    metadata:\n      labels:\n        app: neuvector-allinone-pod\n    spec:\n      hostPID: true\n      serviceAccountName: controller\n      serviceAccount: controller\n      containers:\n        - name: neuvector-allinone-pod\n          image: image-registry.openshift-image-registry.svc:5000/neuvector/allinone:<version>\n          securityContext:\n            privileged: true\n          readinessProbe:\n            exec:\n              command:\n              - cat\n              - /tmp/ready\n            initialDelaySeconds: 5\n            periodSeconds: 5\n          env:\n            - name: CLUSTER_JOIN_ADDR\n              value: neuvector-svc-allinone.neuvector\n            - name: CLUSTER_ADVERTISED_ADDR\n              valueFrom:\n                fieldRef:\n                  fieldPath: status.podIP\n            - name: CLUSTER_BIND_ADDR\n              valueFrom:\n                fieldRef:\n                  fieldPath: status.podIP\n          volumeMounts:\n            - mountPath: /lib/modules\n              name: modules-vol\n              readOnly: true\n            - mountPath: /var/neuvector\n              name: nv-share\n              readOnly: false\n            - mountPath: /var/run/crio/crio.sock\n              name: runtime-sock\n              readOnly: true\n            - mountPath: /host/proc\n              name: proc-vol\n              readOnly: true\n            - mountPath: /host/cgroup\n              name: cgroup-vol\n              readOnly: true\n            - mountPath: /etc/config\n              name: config-volume\n              readOnly: true\n      terminationGracePeriodSeconds: 1200\n      nodeSelector:\n        nvallinone: "true"\n      restartPolicy: Always\n      volumes:\n        - name: modules-vol\n          hostPath:\n            path: /lib/modules\n        - name: nv-share\n          hostPath:\n            path: /var/neuvector\n        - name: runtime-sock\n          hostPath:\n            path: /var/run/crio/crio.sock\n        - name: proc-vol\n          hostPath:\n            path: /proc\n        - name: cgroup-vol\n          hostPath:\n            path: /sys/fs/cgroup\n        - name: config-volume\n          projected:\n            sources:\n              - configMap:\n                  name: neuvector-init\n                  optional: true\n              - secret:\n                  name: neuvector-init\n                  optional: true\n\n---\n\napiVersion: apps/v1\nkind: DaemonSet\nmetadata:\n  name: neuvector-enforcer-pod\n  namespace: neuvector\nspec:\n  selector:\n    matchLabels:\n      app: neuvector-enforcer-pod\n  updateStrategy:\n    type: RollingUpdate\n  template:\n    metadata:\n      labels:\n        app: neuvector-enforcer-pod\n    spec:\n      tolerations:\n        - effect: NoSchedule\n          key: node-role.kubernetes.io/master\n        - effect: NoSchedule\n          key: node-role.kubernetes.io/control-plane\n      affinity:\n        nodeAffinity:\n          requiredDuringSchedulingIgnoredDuringExecution:\n            nodeSelectorTerms:\n              - matchExpressions:\n                - key: "nvallinone"\n                  operator: NotIn\n                  values: ["true"]\n      hostPID: true\n      serviceAccountName: enforcer\n      serviceAccount: enforcer\n      containers:\n        - name: neuvector-enforcer-pod\n          image: image-registry.openshift-image-registry.svc:5000/neuvector/enforcer:<version>\n          securityContext:\n            privileged: true\n          env:\n            - name: CLUSTER_JOIN_ADDR\n              value: neuvector-svc-allinone.neuvector\n            - name: CLUSTER_ADVERTISED_ADDR\n              valueFrom:\n                fieldRef:\n                  fieldPath: status.podIP\n            - name: CLUSTER_BIND_ADDR\n              valueFrom:\n                fieldRef:\n                  fieldPath: status.podIP\n          volumeMounts:\n            - mountPath: /lib/modules\n              name: modules-vol\n              readOnly: true\n            - mountPath: /var/run/crio/crio.sock\n              name: runtime-sock\n              readOnly: true\n            - mountPath: /host/proc\n              name: proc-vol\n              readOnly: true\n            - mountPath: /host/cgroup\n              name: cgroup-vol\n              readOnly: true\n      terminationGracePeriodSeconds: 1200\n      restartPolicy: Always\n      volumes:\n        - name: modules-vol\n          hostPath:\n            path: /lib/modules\n        - name: runtime-sock\n          hostPath:\n            path: /var/run/crio/crio.sock\n        - name: proc-vol\n          hostPath:\n            path: /proc\n        - name: cgroup-vol\n          hostPath:\n            path: /sys/fs/cgroup\n\n---\n\napiVersion: apps/v1\nkind: Deployment\nmetadata:\n  name: neuvector-scanner-pod\n  namespace: neuvector\nspec:\n  selector:\n    matchLabels:\n      app: neuvector-scanner-pod\n  strategy:\n    type: RollingUpdate\n    rollingUpdate:\n      maxSurge: 1\n      maxUnavailable: 0\n  replicas: 2\n  template:\n    metadata:\n      labels:\n        app: neuvector-scanner-pod\n    spec:\n      serviceAccountName: basic\n      serviceAccount: basic\n      containers:\n        - name: neuvector-scanner-pod\n          image: image-registry.openshift-image-registry.svc:5000/neuvector/scanner:latest\n          imagePullPolicy: Always\n          env:\n            - name: CLUSTER_JOIN_ADDR\n              value: neuvector-svc-controller.neuvector\n      restartPolicy: Always\n\n---\n\napiVersion: batch/v1\nkind: CronJob\nmetadata:\n  name: neuvector-updater-pod\n  namespace: neuvector\nspec:\n  schedule: "0 0 * * *"\n  jobTemplate:\n    spec:\n      template:\n        metadata:\n          labels:\n            app: neuvector-updater-pod\n        spec:\n          serviceAccountName: updater\n          serviceAccount: updater\n          containers:\n          - name: neuvector-updater-pod\n            image: image-registry.openshift-image-registry.svc:5000/neuvector/updater:latest\n            imagePullPolicy: Always\n            command:\n            - /bin/sh\n            - -c\n            - TOKEN=`cat /var/run/secrets/kubernetes.io/serviceaccount/token`; /usr/bin/curl -kv -X PATCH -H "Authorization:Bearer $TOKEN" -H "Content-Type:application/strategic-merge-patch+json" -d \'{"spec":{"template":{"metadata":{"annotations":{"kubectl.kubernetes.io/restartedAt":"\'`date +%Y-%m-%dT%H:%M:%S%z`\'"}}}}}\' \'https://kubernetes.default/apis/apps/v1/namespaces/neuvector/deployments/neuvector-scanner-pod\'\n          restartPolicy: Never\n'})}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Master Node Taints and Tolerations"})}),"\n",(0,r.jsx)(n.p,{children:"All taint info must match to schedule Enforcers on nodes. To check the taint info on a node (e.g. Master):"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-shell",children:"oc get node taintnodename -o yaml\n"})}),"\n",(0,r.jsx)(n.p,{children:"Sample output:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-yaml",children:"spec:\n  taints:\n  - effect: NoSchedule\n    key: node-role.kubernetes.io/master\n  # there may be an extra info for taint as below\n  - effect: NoSchedule\n    key: mykey\n    value: myvalue\n"})}),"\n",(0,r.jsx)(n.p,{children:"If there is additional taints as above, add these to the sample yaml tolerations section:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-yaml",children:"spec:\n  template:\n    spec:\n      tolerations:\n        - effect: NoSchedule\n          key: node-role.kubernetes.io/master\n        - effect: NoSchedule\n          key: node-role.kubernetes.io/control-plane\n        # if there is an extra info for taints as above, please add it here. This is required to match all the taint info defined on the taint node. Otherwise, the Enforcer won't deploy on the taint node\n        - effect: NoSchedule\n          key: mykey\n          value: myvalue\n"})}),"\n",(0,r.jsx)(n.h3,{id:"enabledisable-scheduling-on-the-master-node",children:"Enable/Disable Scheduling on the Master Node"}),"\n",(0,r.jsx)(n.p,{children:"The following commands can be used to enable/disable the scheduling on the master node."}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-shell",children:"oc adm manage-node nodename --schedulable\n"})}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-shell",children:"oc adm manage-node nodename --schedulable=false\n"})})]})}function d(e={}){const{wrapper:n}={...(0,t.a)(),...e.components};return n?(0,r.jsx)(n,{...e,children:(0,r.jsx)(u,{...e})}):u(e)}},11151:(e,n,o)=>{o.d(n,{Z:()=>i,a:()=>s});var r=o(67294);const t={},c=r.createContext(t);function s(e){const n=r.useContext(c);return r.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function i(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(t):e.components||t:s(e.components),r.createElement(c.Provider,{value:n},e.children)}}}]);