"use strict";(self.webpackChunkdocs=self.webpackChunkdocs||[]).push([[1962],{38577:(e,n,o)=>{o.r(n),o.d(n,{assets:()=>l,contentTitle:()=>i,default:()=>p,frontMatter:()=>s,metadata:()=>c,toc:()=>a});var r=o(74848),t=o(28453);const s={title:"Mirantis Kubernetes Engine",taxonomy:{category:"docs"},slug:"/special/docker"},i=void 0,c={id:"special/docker/docker",title:"Mirantis Kubernetes Engine",description:"Deploy to Swarm Cluster",source:"@site/docs/13.special/02.docker/02.docker.md",sourceDirName:"13.special/02.docker",slug:"/special/docker",permalink:"/next/special/docker",draft:!1,unlisted:!1,editUrl:"https://github.com/neuvector/docs/edit/main/docs/13.special/02.docker/02.docker.md",tags:[],version:"current",sidebarPosition:2,frontMatter:{title:"Mirantis Kubernetes Engine",taxonomy:{category:"docs"},slug:"/special/docker"},sidebar:"tutorialSidebar",previous:{title:"General Guidelines",permalink:"/next/special/general"},next:{title:"14. Release Notes",permalink:"/next/releasenotes"}},l={},a=[{value:"Deploy to Swarm Cluster",id:"deploy-to-swarm-cluster",level:3},{value:"Deploy on Docker Swarm Using Privileged Mode",id:"deploy-on-docker-swarm-using-privileged-mode",level:3},{value:"Deployment Without Using Privileged Mode",id:"deployment-without-using-privileged-mode",level:3}];function d(e){const n={code:"code",em:"em",h3:"h3",p:"p",pre:"pre",strong:"strong",...(0,t.R)(),...e.components};return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(n.h3,{id:"deploy-to-swarm-cluster",children:"Deploy to Swarm Cluster"}),"\n",(0,r.jsx)(n.p,{children:"To deploy NeuVector using a Swarm cluster, first pull the NeuVector images using Docker UCP in the Images menu. You may need to add a version number to get the latest version on Docker Hub."}),"\n",(0,r.jsx)(n.p,{children:"Currently, Swarm/UCP does not support the seccomp capabilities (cap_add options) or deploying in \u2018privileged mode\u2019 so the NeuVector containers will need to be deployed from the command line using docker-compose or run. See the sample compose files for the allinone and enforcer below."}),"\n",(0,r.jsx)(n.p,{children:"The Docker UCP HRM service uses the default port 8443 which conflicts with the NeuVector console port. If using the default HRM port, then change the NeuVector port mapping, for example 9443:8443 for the allinone container in the examples below. After the NeuVector application is successfully deployed, login to the console on port 9443 of the allinone host."}),"\n",(0,r.jsx)(n.h3,{id:"deploy-on-docker-swarm-using-privileged-mode",children:"Deploy on Docker Swarm Using Privileged Mode"}),"\n",(0,r.jsx)(n.p,{children:"The following is an example of the docker-compose file to deploy the all-in-one container on the first node. Because the all-in-one container has an enforcer module inside, application containers on the same node can be secured. Both greenfield and brownfield deployment are supported."}),"\n",(0,r.jsx)(n.p,{children:"Deploy all-in-one using docker-compose (privileged mode):"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-yaml",children:"allinone:\n    pid: host\n    image: neuvector/allinone:<version>\n    container_name: allinone\n    privileged: true\n    environment:\n        - CLUSTER_JOIN_ADDR=node_ip\n    ports:\n        - 18300:18300\n        - 18301:18301\n        - 18400:18400\n        - 18401:18401\n        - 18301:18301/udp\n        - 9443:8443\n    volumes:\n        - /lib/modules:/lib/modules\n        - /var/neuvector:/var/neuvector\n        - /var/run/docker.sock:/var/run/docker.sock\n        - /proc:/host/proc:ro\n        - /sys/fs/cgroup:/host/cgroup:ro\n"})}),"\n",(0,r.jsxs)(n.p,{children:["The most important environment variable is the ",(0,r.jsx)(n.strong,{children:"CLUSTER_JOIN_ADDR"}),". It is the IP address that other enforcers connect to. Normally, it should be set to the IP address of the node where all-in-one container is running."]}),"\n",(0,r.jsxs)(n.p,{children:["Port 18300 and 18301 are default ports for cluster communication. They must be identical for all controllers and enforcers in the cluster. Please refer to ",(0,r.jsx)(n.em,{children:'"Docker-compose Details"'})," section for how to change the default ports."]}),"\n",(0,r.jsx)(n.p,{children:"Add an enforcer container using docker-compose (privileged mode)"}),"\n",(0,r.jsx)(n.p,{children:"This is an example of docker-compose file to join an enforcer into the cluster. Both greenfield and brownfield deployment are supported."}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-yaml",children:"enforcer:\n    pid: host\n    image: neuvector/enforcer:<version>\n    container_name: enforcer\n    privileged: true\n    environment:\n        - CLUSTER_JOIN_ADDR=controller_node_ip\n    ports:\n        - 18301:18301\n        - 18401:18401\n        - 18301:18301/udp\n    volumes:\n        - /lib/modules:/lib/modules\n        - /var/run/docker.sock:/var/run/docker.sock\n        - /proc:/host/proc:ro\n        - /sys/fs/cgroup/:/host/cgroup/:ro\n"})}),"\n",(0,r.jsxs)(n.p,{children:["The most important environment variable is ",(0,r.jsx)(n.strong,{children:"CLUSTER_JOIN_ADDR"}),". For enforcers, replace ",(0,r.jsx)(n.code,{children:"<controller_node_ip>"})," with the controller's node IP address. Typically, ",(0,r.jsx)(n.strong,{children:"CLUSTER_JOIN_ADDR"})," in the controller/all-in-one's docker-compose file and enforcer's docker-compose file have the same value."]}),"\n",(0,r.jsx)(n.p,{children:"From NeuVector 4.0+, a separate scanner container must be deployed to perform vulnerability scanning."}),"\n",(0,r.jsx)(n.p,{children:"Sample docker-compose for the Scanner:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-yaml",children:"Scanner:\n   image: neuvector/scanner\n   container_name: scanner\n   environment:\n     - SCANNER_DOCKER_URL=tcp://192.168.1.10:2376\n     - CLUSTER_JOIN_ADDR=controller_node_ip\n   ports:\n     - 18402:18402\n   volumes:\n     - /var/run/docker.sock:/var/run/docker.sock:ro\n"})}),"\n",(0,r.jsx)(n.h3,{id:"deployment-without-using-privileged-mode",children:"Deployment Without Using Privileged Mode"}),"\n",(0,r.jsx)(n.p,{children:"For some platform configurations it is possible to deploy the NeuVector containers without requiring them to run in privileged mode. The configuration must support the ability to add capabilities and set the apparmour profile. Note that Docker DataCenter/UCP and Swarm currently do not support this, but it is still possible to deploy NeuVector manually using Compose or Run."}),"\n",(0,r.jsx)(n.p,{children:"Deploy allinone (NO privileged mode) with docker-compose"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-yaml",children:"allinone:\n    pid: host\n    image: neuvector/allinone\n    container_name: neuvector.allinone\n    cap_add:\n        - SYS_ADMIN\n        - NET_ADMIN\n        - SYS_PTRACE\n        - IPC_LOCK\n    security_opt:\n        - apparmor=unconfined\n        - seccomp=unconfined\n        - label=disable\n    environment:\n        - CLUSTER_JOIN_ADDR=[AllInOne Node IP Address]\n    ports:\n        - 18300:18300\n        - 18301:18301\n        - 18400:18400\n        - 18401:18401\n        - 18301:18301/udp\n        - 9443:8443\n    volumes:\n        - /lib/modules:/lib/modules\n        - /var/run/docker.sock:/var/run/docker.sock\n        - /proc:/host/proc:ro\n        - /sys/fs/cgroup:/host/cgroup:ro\n        - /var/neuvector:/var/neuvector\n"})}),"\n",(0,r.jsx)(n.p,{children:"Deploy enforcer (NO privileged mode) with docker-compose"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-yaml",children:"enforcer:\n    pid: host\n    image: neuvector/enforcer\n    container_name: neuvector.enforcer\n    cap_add:\n        - SYS_ADMIN\n        - NET_ADMIN\n        - SYS_PTRACE\n        - IPC_LOCK\n    security_opt:\n        - apparmor=unconfined\n        - seccomp=unconfined\n        - label=disable\n    environment:\n        - CLUSTER_JOIN_ADDR=[AllInOne Node IP Address]\n    ports:\n        - 18301:18301\n        - 18401:18401\n        - 18301:18301/udp\n    volumes:\n        - /lib/modules:/lib/modules\n        - /var/run/docker.sock:/var/run/docker.sock\n        - /proc:/host/proc:ro\n        - /sys/fs/cgroup/:/host/cgroup/:ro\n"})})]})}function p(e={}){const{wrapper:n}={...(0,t.R)(),...e.components};return n?(0,r.jsx)(n,{...e,children:(0,r.jsx)(d,{...e})}):d(e)}},28453:(e,n,o)=>{o.d(n,{R:()=>i,x:()=>c});var r=o(96540);const t={},s=r.createContext(t);function i(e){const n=r.useContext(s);return r.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function c(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(t):e.components||t:i(e.components),r.createElement(s.Provider,{value:n},e.children)}}}]);